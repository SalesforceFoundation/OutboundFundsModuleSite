minimum_cumulusci_version: "3.27.0"
project:
    name: OutboundFundsCommunity
    package:
        name: Outbound Funds Community
        namespace: outfunds_comm
        api_version: "50.0"
    dependencies:
        - namespace: sfdobase
          version: 1.0
        - github: "https://github.com/SalesforceFoundation/OutboundFunds"
    git:
        default_branch: "main"
    source_format: sfdx

orgs:
    scratch:
        2gp:
            config_file: orgs/dev.json
            days: 7

tasks:
    # Automerge Major Release Branches
    github_automerge_feature:
        options:
            update_future_releases: True

    # Robot test configuration
    robot:
        options:
            suites: robot/OutboundFundsCommunity/tests
            options:
                outputdir: robot/OutboundFundsCommunity/results

    robot_testdoc:
        options:
            path: robot/OutboundFundsCommunity/tests
            output: robot/OutboundFundsCommunity/doc/OutboundFundsCommunity_tests.html

    run_tests:
        options:
            required_org_code_coverage_percent: 100

    # Fundseeker customer enablement
    fundseeker_create_site:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Creates a site with the OFM Experience Template.
        class_path: cumulusci.tasks.salesforce.CreateCommunity
        options:
            template: OFM-Portal
            name: Outbound Funds Portal
            url_path_prefix: outboundfunds
            timeout: 60000

    fundseeker_publish_site:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Publishes the Outbound Funds Portal site so we can later deploy NetworkBranding.
        class_path: cumulusci.tasks.salesforce.PublishCommunity
        options:
            name: Outbound Funds Portal

    fundseeker_deploy_navigation_menu:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Deploys our recommended Navigation Menu for the Fundseeker Site.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/fundseeker_customer_enablement/navigation_menu

    fundseeker_configure_guest_user_profile:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Deploys our recommended configuration of the Site Guest User Profile.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/fundseeker_customer_enablement/guest_user_profile

    fundseeker_create_network_members:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Create a NetworkMemberGroup records.
        class_path: tasks.network_member_group.CreateNetworkMemberGroups
        options:
            network_name: Outbound Funds Portal
            profile_names:
                - Fundseeker Plus Login

    fundseeker_deploy_sharing_set:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Deploys our recommended Sharing Set for the Fundseeker Plus Login Profile.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/fundseeker_customer_enablement/sharing_set

    # All stories
    secure_owds_by_default:
        group: "OFM-Site: stories"
        description: Sets organization-wide default (OWD) sharing configuration as private both internally and externally.
        class_path: cumulusci.tasks.metadata_etl.SetOrgWideDefaults
        options:
            org_wide_defaults:
                - api_name: Account
                  internal_sharing_model: Private
                  external_sharing_model: Private
                # Opportunity + Case must have a sharing model â‰¤ Account's sharing model.
                - api_name: Opportunity
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: Case
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: User
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Funding_Program__c
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Funding_Request__c
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Requirement__c
                  internal_sharing_model: Private
                  external_sharing_model: Private

    # dev story
    dev_deploy_unpackaged:
        group: "OFM-Site: stories/dev"
        description: Deploys the bundle of unpackaged for the dev story.
        class_path: cumulusci.tasks.salesforce.DeployBundles
        options:
            path: stories/dev/unpackaged

    dev_load_storytelling_data:
        group: "OFM-Site: stories/dev"
        description: Load storytelling data for the dev story.   Note, this dataset depends on the unpackaged metadata in the dev story.
        class_path: cumulusci.tasks.bulkdata.LoadData
        options:
            mapping: stories/dev/dataset/mapping.yml
            sql_path: stories/dev/dataset/data.sql

    dev_extract_storytelling_data:
        group: "OFM-Site: stories/dev"
        description: Extract storytelling data for the dev story.
        class_path: cumulusci.tasks.bulkdata.ExtractData
        options:
            mapping: stories/dev/dataset/mapping.yml
            sql_path: stories/dev/dataset/data.sql

    dev_update_default_scratch_org_user:
        group: "OFM-Site: stories/dev"
        description: Updates the default scratch org user to be Aileen Davis, and assigns her a role so her accounts can have community users.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/dev/scripts/update_scratch_org_user.apex

    dev_create_site_users:
        group: "OFM-Site: stories/dev"
        description: Creates site users for the Outbound Funds Portal.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/dev/scripts/create_site_users.apex
            # Comma-delimited list of Contact.Email to create site users.
            param1: meiko.takagawa@takagawa-institute.example.com,devon.berger@hillside-elementary.example.com,ellen.perez@steps.example.com,grace.walker@steps.example.com

    dev_reorder_app_menu:
        group: "OFM-Site: stories/dev"
        description: Re-orders the app menu for the dev story.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/dev/scripts/reorder_app_menu.apex
            param1: "Outbound_Funds,outbound funds portal,Community"

    dev_upload_photo_for_admin_aileen_davis:
        group: "OFM-Site: stories/dev"
        description: Uploads a profile photo for admin Aileen Davis.
        class_path: cumulusci.tasks.salesforce.users.photos.UploadProfilePhoto
        options:
            photo: stories/dev/images/photos/AileenDavis.png

    dev_upload_photo_for_fundseeker_grace_walker:
        group: "OFM-Site: stories/dev"
        description: Uploads a profile photo for fundseeker Grace Walker.
        class_path: cumulusci.tasks.salesforce.users.photos.UploadProfilePhoto
        options:
            photo: stories/dev/images/photos/GraceWalker.png
            where: Contact.Email = 'grace.walker@steps.example.com'

    dev_share_funding_programs_with_accounts_with_funding_requests:
        group: "OFM-Site: stories/dev"
        description: Grants read sharing-access to an account's Portal Role And Subordinates for all Funding Programs where the account has a Funding Request.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/dev/scripts/reorder_app_menu.apex
            param1: "Outbound_Funds,outbound funds portal,Community"

    # qa story
    qa_reorder_app_menu:
        group: "OFM-Site: stories/dev"
        description: Re-orders the app menu for the qa story.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/qa/scripts/reorder_app_menu.apex
            param1: "Outbound_Funds,outbound funds portal,Community"

    # Internal development automation
    dev_export_ofm_community_template:
        group: "OFM: Internal dev automation"
        description: 'Exports specified temporary Community Template metadata. Change the options to export changes you are interested in. Remember, the temporary Community Template API Name must start with "template_name" option, and the "suffix" is everything after the "template_name" option in temporary Community Template API Name.'
        class_path: dev.tasks.community_templates.ExportCommunityTemplateTask
        options:
            template_name: OFM_Portal
            suffix: "3"
            export_template: True
            export_theme: True
            export_branding_set: True
            export_flexipages: True
            copy_temporary_metadata: False

flows:
    # dev story
    dev_story:
        steps:
            1:
                flow: fundseeker_customer_enablement
            2:
                task: secure_owds_by_default
            3:
                task: dev_deploy_unpackaged
            4:
                task: dev_reorder_app_menu
            5:
                task: dev_load_storytelling_data
            6:
                task: dev_update_default_scratch_org_user
            7:
                task: dev_create_site_users
            8:
                task: dev_upload_photo_for_admin_aileen_davis
            9:
                task: dev_upload_photo_for_fundseeker_grace_walker
            10:
                task: dev_share_funding_programs_with_accounts_with_funding_requests

    config_dev:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: dev_story

    dev_org_2gp:
        steps:
            1:
                flow: install_2gp_commit
            2:
                flow: config_dev
            3:
                task: snapshot_changes

    # qa story
    qa_story:
        steps:
            1:
                flow: fundseeker_customer_enablement
            2:
                task: secure_owds_by_default
            3:
                task: qa_reorder_app_menu

    config_qa:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: qa_story

    # beta story
    config_managed:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                task: secure_owds_by_default

    # Customer flows
    fundseeker_customer_enablement:
        description: Customer enablement for the Outbound Funds Portal.
        steps:
            1:
                task: fundseeker_create_site
            2:
                task: fundseeker_publish_site
            3:
                task: fundseeker_create_network_members
            4:
                task: fundseeker_deploy_navigation_menu
            5:
                task: fundseeker_configure_guest_user_profile
            6:
                task: fundseeker_deploy_sharing_set
