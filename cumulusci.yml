# * Copyright (c) 2021, salesforce.com, inc.
# * All rights reserved.
# * SPDX-License-Identifier: BSD-3-Clause
# * For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/BSD-3-Clause
# *
minimum_cumulusci_version: "3.32.0"
project:
    name: OutboundFundsCommunity
    package:
        name: Outbound Funds Community
        namespace: outfunds_comm
        api_version: "50.0"
    dependencies:
        - namespace: sfdobase
          version: 1.0
        - github: "https://github.com/SalesforceFoundation/OutboundFundsModule"
    dependency_resolutions:
        preproduction: include_beta
    git:
        default_branch: "main"
        repo_url: "https://github.com/SalesforceFoundation/OutboundFundsModuleSite"
    source_format: sfdx

tasks:
    # Automerge Major Release Branches
    github_automerge_feature:
        options:
            update_future_releases: True

    # Robot test configuration
    robot:
        options:
            suites: robot/OutboundFundsCommunity/tests
            options:
                outputdir: robot/OutboundFundsCommunity/results

    robot_testdoc:
        options:
            path: robot/OutboundFundsCommunity/tests
            output: robot/OutboundFundsCommunity/doc/OutboundFundsCommunity_tests.html

    run_tests:
        options:
            retry_failures:
                - "unable to obtain exclusive access to this record"
                - "UNABLE_TO_LOCK_ROW"
            retry_always: True
            required_org_code_coverage_percent: "100"

    robot_libdoc:
        options:
            path: robot/OutboundFundsCommunity/resources/OutboundFundsCommunity.py,robot/OutboundFundsCommunity/resources/OutboundFundsCommunity.robot,robot/OutboundFundsCommunity/resources/*PageObject.py
            output: robot/OutboundFundsCommunity/doc/Keywords.html

    uninstall_packaged_incremental:
        options:
            ignore:
                ContentAsset:
                    - Outbound_Funds_Module_Default_Hero
                    - Outbound_Funds_Module_Default_Logo
                    - Outbound_Funds_Module_Body
                    - GCCS_Foundation_hero
                    - GCCS_Foundation_logo

    # Fundseeker customer enablement
    fundseeker_create_site:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Creates a site with the OFM Experience Template.
        class_path: cumulusci.tasks.salesforce.CreateCommunity
        options:
            template: Fundseeker Starter Portal
            name: Fundseeker Portal
            url_path_prefix: fundseekerportal
            timeout: 60000

    fundseeker_publish_site:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Publishes the Fundseeker Portal site so we can later deploy NetworkBranding.
        class_path: cumulusci.tasks.salesforce.PublishCommunity
        options:
            name: Fundseeker Portal

    fundseeker_configure_guest_user_profile:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Deploys our recommended configuration of the Site Guest User Profile, e.g. assigns Layouts.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/fundseeker_customer_enablement/guest_user_profile

    fundseeker_add_network_members:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Create a NetworkMemberGroup records.
        class_path: cumulusci.tasks.salesforce.network_member_group.CreateNetworkMemberGroups
        options:
            network_name: Fundseeker Portal
            profile_names:
                - Fundseeker Plus Login

    fundseeker_deploy_network_branding:
        group: "SFDO-Grants: Customer enablement"
        description: Deploys the NetworkBranding files for the Fundseeker Portal. Must be deployed after creating the "Fundseeker Portal" Community.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/fundseeker_customer_enablement/network_branding

    fundseeker_deploy_sharing_set:
        group: "OFM-Site: Fundseeker customer enablement"
        description: Deploys our recommended Sharing Set for the Fundseeker Plus Login Profile.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/fundseeker_customer_enablement/sharing_set

    fundseeker_check_sharing_set_owds:
        class_path: cumulusci.tasks.preflight.sobjects.CheckSObjectOWDs
        group: "Preflight Checks"
        options:
            org_wide_defaults:
                - api_name: outfunds__Funding_Request__c
                  external_sharing_model: Private
                - api_name: outfunds__Requirement__c
                  external_sharing_model: Private

    fundseeker_check_enable_networks_enabled:
        description: Preflight check to validate that Digital Experiences are enabled.
        group: "Preflight Checks"
        class_path: cumulusci.tasks.preflight.settings.CheckSettingsValue
        options:
            settings_type: CommunitiesSettings
            settings_field: IsNetworksEnabledEnabled
            value: true

    # All stories
    common_secure_owds_by_default:
        group: "OFM-Site: stories"
        description: Sets organization-wide default (OWD) sharing configuration as private both internally and externally.
        class_path: cumulusci.tasks.metadata_etl.SetOrgWideDefaults
        options:
            org_wide_defaults:
                - api_name: Account
                  internal_sharing_model: Private
                  external_sharing_model: Private
                # Opportunity + Case must have a sharing model ≤ Account's sharing model.
                - api_name: Opportunity
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: Case
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: User
                  internal_sharing_model: Read
                  external_sharing_model: Read
                - api_name: outfunds__Funding_Program__c
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Funding_Request__c
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Requirement__c
                  internal_sharing_model: Private
                  external_sharing_model: Private

    common_update_default_scratch_org_user:
        group: "OFM-Site: stories/common"
        description: Updates the default scratch org user to be Aileen Davis, and assigns her a role so her accounts can have community users.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/common/scripts/update_scratch_org_user.apex

    common_create_site_users:
        group: "OFM-Site: stories/common"
        description: Creates site users for the Fundseeker Portal.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/common/scripts/create_site_users.apex
            # param1 is a comma-delimited list of Contact.Email to create site users.

    common_reorder_app_menu:
        group: "OFM-Site: stories/common"
        description: Re-orders the app menu for the common story.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/common/scripts/reorder_app_menu.apex
            # param1 is a comma-delimited list of Application Names.

    common_upload_photo_for_admin_aileen_davis:
        group: "OFM-Site: stories/common"
        description: Uploads a profile photo for admin Aileen Davis.
        class_path: cumulusci.tasks.salesforce.users.photos.UploadProfilePhoto
        options:
            photo: stories/common/images/photos/AileenDavis.png

    common_upload_photo_for_fundseeker_grace_walker:
        group: "OFM-Site: stories/common"
        description: Uploads a profile photo for fundseeker Grace Walker.
        class_path: cumulusci.tasks.salesforce.users.photos.UploadProfilePhoto
        options:
            photo: stories/common/images/photos/GraceWalker.png
            where: Contact.Email = 'grace.walker@steps.example.com'

    common_share_funding_programs_with_accounts_with_funding_requests:
        group: "OFM-Site: stories/common"
        description: If an account has a Funding Request, that site users for that account should be able to view the Funding Program record.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/common/scripts/share_funding_programs_with_requests.apex

    # dev story
    dev_deploy_unpackaged:
        group: "OFM-Site: stories/dev"
        description: Deploys the bundle of unpackaged for the dev story.
        class_path: cumulusci.tasks.salesforce.DeployBundles
        options:
            path: stories/dev/unpackaged

    dev_load_storytelling_data:
        group: "OFM-Site: stories/dev"
        description: Load storytelling data for the dev story.   Note, this dataset depends on the unpackaged metadata in the dev story.
        class_path: cumulusci.tasks.bulkdata.LoadData
        options:
            mapping: stories/dev/dataset/mapping.yml
            sql_path: stories/dev/dataset/data.sql

    dev_extract_storytelling_data:
        group: "OFM-Site: stories/dev"
        description: Extract storytelling data for the dev story.
        class_path: cumulusci.tasks.bulkdata.ExtractData
        options:
            mapping: stories/dev/dataset/mapping.yml
            sql_path: stories/dev/dataset/data.sql

    # qa story
    qa_deploy_unpackaged:
        group: "OFM-Site: stories/qa"
        description: Deploys the bundle of unpackaged for the qa story.
        class_path: cumulusci.tasks.salesforce.DeployBundles
        options:
            path: stories/qa/unpackaged

    qa_load_storytelling_data:
        group: "OFM-Site: stories/qa"
        description: Load storytelling data for the qa story.   Note, this dataset depends on the unpackaged metadata in the qa story.
        class_path: cumulusci.tasks.bulkdata.LoadData
        options:
            mapping: stories/qa/dataset/mapping.yml
            sql_path: stories/qa/dataset/data.sql

    qa_extract_storytelling_data:
        group: "OFM-Site: stories/qa"
        description: Extract storytelling data for the qa story.
        class_path: cumulusci.tasks.bulkdata.ExtractData
        options:
            mapping: stories/qa/dataset/mapping.yml
            sql_path: stories/qa/dataset/data.sql

    # Internal development automation
    dev_export_ofm_community_template:
        group: "OFM: Internal dev automation"
        description: 'Exports specified temporary Community Template metadata. Change the options to export changes you are interested in. Remember, the temporary Community Template API Name must start with "template_name" option, and the "suffix" is everything after the "template_name" option in temporary Community Template API Name.'
        class_path: dev.tasks.community_templates.ExportCommunityTemplateTask
        options:
            template_name: OFM_Portal
            suffix: "2"
            export_template: True
            export_theme: True
            export_branding_set: True
            export_flexipages: True
            copy_temporary_metadata: False

    common_replace_theme_layout_navigation_menu:
        group: "SFDO-Grants: Internal config and storytelling"
        description: Replaces the Navigation Menu in the community for all pages using the Grants Community theme
        class_path: dev.tasks.communities.ReplaceThemeLayoutNavigationMenuTask
        options:
            network_name: Fundseeker Portal
            navigation_menu: OFM_Portal_Navigation1

flows:
    # dev story
    dev_story:
        steps:
            1:
                flow: fundseeker_customer_enablement
            2:
                task: common_secure_owds_by_default
            3:
                task: dev_deploy_unpackaged
            4:
                task: common_reorder_app_menu
                options:
                    param1: "Outbound_Funds,outbound funds portal,Community"
            5:
                task: dev_load_storytelling_data
            6:
                task: common_update_default_scratch_org_user
            7:
                task: common_create_site_users
                options:
                    param1: meiko.takagawa@takagawa-institute.example.com,devon.berger@hillside-elementary.example.com,ellen.perez@steps.example.com,grace.walker@steps.example.com
            8:
                task: common_upload_photo_for_admin_aileen_davis
            9:
                task: common_upload_photo_for_fundseeker_grace_walker
            10:
                task: common_share_funding_programs_with_accounts_with_funding_requests
            11:
                flow: common_replace_and_publish_theme_layout_navigation_menu

    config_dev:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: dev_story

    dev_org_2gp:
        steps:
            1:
                flow: install_2gp_commit
            2:
                flow: config_dev
            3:
                task: snapshot_changes

    # qa story
    qa_story:
        steps:
            1:
                flow: fundseeker_customer_enablement
            2:
                task: common_secure_owds_by_default
            3:
                task: qa_deploy_unpackaged
            4:
                task: common_reorder_app_menu
                options:
                    param1: "Outbound_Funds,outbound funds portal,Community"
            5:
                task: qa_load_storytelling_data
            6:
                task: common_update_default_scratch_org_user
            7:
                task: common_create_site_users
                options:
                    param1: meiko.takagawa@takagawa-institute.example.com,devon.berger@hillside-elementary.example.com,ellen.perez@steps.example.com,grace.walker@steps.example.com
            8:
                task: common_upload_photo_for_admin_aileen_davis
            9:
                task: common_upload_photo_for_fundseeker_grace_walker
            10:
                task: common_share_funding_programs_with_accounts_with_funding_requests
            11:
                flow: common_replace_and_publish_theme_layout_navigation_menu

    config_qa:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: qa_story

    # beta story
    config_managed:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                task: common_secure_owds_by_default

    # Customer flows
    fundseeker_customer_enablement:
        description: Customer enablement for the Fundseeker Portal with recommended configuration.
        steps:
            1:
                task: fundseeker_create_site
                ui_options:
                    name: "Create the Fundseeker Portal"
                    is_required: True
            2:
                task: fundseeker_publish_site
                ui_options:
                    name: "Publish the Fundseeker Portal"
                    is_required: True
            3:
                task: fundseeker_add_network_members
                ui_options:
                    name: "Add 'Fundseeker Plus Login' Profile to Fundseeker Portal"
                    is_required: True
            4:
                task: fundseeker_configure_guest_user_profile
                ui_options:
                    name: "Update 'Fundseeker Portal Profile' (Guest User) profile"
                    is_required: True
            5:
                task: fundseeker_deploy_sharing_set
                ui_options:
                    name: "Grant Visibility to Site Users"
                    is_required: True
                checks:
                    - when: "not tasks.fundseeker_check_sharing_set_owds()"
                      action: hide

    # Internal flows
    common_replace_and_publish_theme_layout_navigation_menu:
        description: Configures the Fundseeker Portal to use the packaged Navigation Menu instead of the default Navigation Menu.  Then, publishes the Site so the changes are committed in the org.
        steps:
            1:
                task: common_replace_theme_layout_navigation_menu
            2:
                task: fundseeker_publish_site

    customer_org:
        steps:
            1:
                task: deploy_pre
                ui_options:
                    template_content_assets:
                        name: Deploy Visual Assets
            2:
                task: install_managed
            3:
                task: deploy_post
                ui_options:
                    funding_program_application_flow:
                        name: Deploy Create Application Flow And Quick Action
                    fundseeker_plus_login_profile:
                        name: Deploy Fundseeker Plus Login Profile
                    funding_request_submission_flow:
                        name: Deploy Submit Application Flow And Quick Action
                    submit_requirement_flow:
                        name: Deploy Submit Requirement Flow And Quick Action

    customer_org_full:
        steps:
            1:
                flow: customer_org
            2:
                flow: fundseeker_customer_enablement

plans:
    customer_enablement_install:
        slug: install-and-build-portal
        title: Install OFM Fundseeker Starter Portal Template and Build Site
        tier: primary
        is_listed: True
        preflight_message: "This installs the Outbound Funds Module Fundseeker Starter Portal Template into your org and creates the Fundseeker Portal with our recommended configurations."
        post_install_message: "Thanks for installing Outbound Funds Module Fundseeker Starter Portal Template. Visit the [Outbound Funds Module Fundseeker Starter Portal Template](https://powerofus.force.com/s/group/0F980000000CvlMCAS) community group on the Power of Us Hub for any questions about Outbound Funds Module or Outbound Funds Module Fundseeker Starter Portal Template."
        error_message: "To get help with this error, go to [help.salesforce.com](https://help.salesforce.com/), find Support & Services, and log a support ticket with Salesforce. Include “Outbound Funds Module Fundseeker Starter Portal Template” in the subject line and the installation link in the comments."
        checks:
            - when: "not tasks.check_chatter_enabled()"
              action: error
              message: "The Fundseeker Starter Portal Template requires that Chatter is enabled. Enable Chatter in your org and try again."
            - when: "'.my.' not in org_config.instance_url"
              action: error
              message: "The Fundseeker Starter Portal Template requires that My Domain is enabled. Enable My Domain in your org and try again."
            - when: "not tasks.fundseeker_check_enable_networks_enabled()"
              action: error
              message: "The Fundseeker Starter Portal Template requires that Digital Experiences is enabled. Enable Digital Experience in your org and try again."
            - when: "'PID_Customer_Community_Plus_Login' not in tasks.get_available_licenses()"
              action: error
              message: "The Fundseeker Starter Portal Template is an Experience Cloud site template and requires Customer Community Plus Login licenses. Coordinate with your Salesforce account executive to be sure you have the correct licenses in your org."
            - when: "'outfunds' not in tasks.get_installed_packages()"
              action: error
              message: "The Outbound Funds Module Fundseeker Starter Portal Template requires Outbound Funds Module is installed first. Visit https://install.salesforce.org/products/outbound-funds/ to install it and try again."
            - when: "'Fundseeker Portal' in tasks.list_communities()"
              action: error
              message: "An Experience Cloud site with the name 'Fundseeker Portal' already exists."

        steps:
            1:
                flow: customer_org_full

    install:
        slug: install
        title: Install OFM Fundseeker Starter Portal Template
        tier: secondary
        is_listed: True
        preflight_message: "This installs the Outbound Funds Module Fundseeker Starter Portal Experience Cloud template in your org."
        post_install_message: "Thanks for installing Outbound Funds Module Fundseeker Starter Portal Template. Visit the [Outbound Funds Module](https://powerofus.force.com/s/group/0F980000000CvlMCAS) community group on the Power of Us Hub for any questions about Outbound Funds Module or Outbound Funds Module Fundseeker Starter Portal Template."
        error_message: "To get help with this error, go to [help.salesforce.com](https://help.salesforce.com/), find Support & Services, and log a support ticket with Salesforce. Include “Outbound Funds Module Fundseeker Starter Portal Template” in the subject line and the installation link in the comments."
        checks:
            - when: "not tasks.check_chatter_enabled()"
              action: error
              message: "Outbound Funds Module Fundseeker Starter Portal Template requires Chatter. Please enable Chatter in your org and try again."
            - when: "'.my.' not in org_config.instance_url"
              action: error
              message: "The Fundseeker Starter Portal Template requires that My Domain is enabled. Enable My Domain in your org and try again."
            - when: "not tasks.fundseeker_check_enable_networks_enabled()"
              action: error
              message: "The Fundseeker Starter Portal Template requires that Digital Experiences is enabled. Enable Digital Experience in your org and try again."
            - when: "'PID_Customer_Community_Plus_Login' not in tasks.get_available_licenses()"
              action: error
              message: "The Fundseeker Starter Portal Template is an Experience Cloud site template and requires Customer Community Plus Login licenses. Coordinate with your Salesforce account executive to be sure you have the correct licenses in your org."
            - when: "'outfunds' not in tasks.get_installed_packages()"
              action: error
              message: "The Outbound Funds Module Fundseeker Starter Portal Template requires Outbound Funds Module is installed first. Visit https://install.salesforce.org/products/outbound-funds/ to install it and try again."

        steps:
            1:
                flow: customer_org
