minimum_cumulusci_version: "3.27.0"
project:
    name: OutboundFundsCommunity
    package:
        name: Outbound Funds Community
        namespace: outfunds_comm
        api_version: "50.0"
    dependencies:
        - namespace: sfdobase
          version: 1.0
        - github: "https://github.com/SalesforceFoundation/OutboundFunds"
    git:
        default_branch: "main"
    source_format: sfdx

orgs:
    scratch:
        2gp:
            config_file: orgs/dev.json
            days: 7

tasks:
    # Automerge Major Release Branches
    github_automerge_feature:
        options:
            update_future_releases: True

    # Robot test configuration
    robot:
        options:
            suites: robot/OutboundFundsCommunity/tests
            options:
                outputdir: robot/OutboundFundsCommunity/results

    robot_testdoc:
        options:
            path: robot/OutboundFundsCommunity/tests
            output: robot/OutboundFundsCommunity/doc/OutboundFundsCommunity_tests.html

    run_tests:
        options:
            required_org_code_coverage_percent: 100

    # Customer Enablement
    create_fundseeker_site:
        group: "OFM-Site: Customer enablement"
        description: Creates a site with the OFM Experience Template.
        class_path: cumulusci.tasks.salesforce.CreateCommunity
        options:
            template: OFM-Portal
            name: Outbound Funds Portal
            url_path_prefix: outboundfunds
            timeout: 60000

    deploy_navigation_menu:
        group: "OFM-Site: Customer enablement"
        description: Deploys our recommended Navigation Menu for the Fundseeker Site
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/customer_enablement/navigation_menu/

    # dev story
    dev_secure_owds_by_default:
        group: "OFM-Site: stories/dev"
        description: Sets organization-wide default (OWD) sharing configuration as private both internally and externally.
        class_path: cumulusci.tasks.metadata_etl.SetOrgWideDefaults
        options:
            org_wide_defaults:
                - api_name: Account
                  internal_sharing_model: Private
                  external_sharing_model: Private
                # Opportunity + Case must have a sharing model â‰¤ Account's sharing model.
                - api_name: Opportunity
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: Case
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: User
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Funding_Program__c
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Funding_Request__c
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Requirement__c
                  internal_sharing_model: Private
                  external_sharing_model: Private

    dev_deploy_unpackaged:
        group: "OFM-Site: stories/dev"
        description: Deploys the bundle of unpackaged for the dev story.
        class_path: cumulusci.tasks.salesforce.DeployBundles
        options:
            path: stories/dev/unpackaged

    dev_load_storytelling_data:
        group: "OFM-Site: stories/dev"
        description: Load dev storytelling data when person accounts is enabled.
        class_path: cumulusci.tasks.bulkdata.LoadData
        options:
            mapping: stories/dev/dataset/mapping.yml
            sql_path: stories/dev/dataset/data.sql

    dev_reorder_app_menu:
        group: "OFM-Site: stories/dev"
        description: Re-orders the app menu for the dev story.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/dev/scripts/reorder_app_menu.apex
            param1: "Outbound_Funds,outbound funds portal,Community"

    # qa story
    qa_reorder_app_menu:
        group: "OFM-Site: stories/dev"
        description: Re-orders the app menu for the qa story.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: stories/qa/scripts/reorder_app_menu.apex
            param1: "Outbound_Funds,outbound funds portal,Community"

    # Internal development automation
    dev_export_ofm_community_template:
        group: "OFM: Internal dev automation"
        description: 'Exports specified temporary Community Template metadata. Change the options to export changes you are interested in. Remember, the temporary Community Template API Name must start with "template_name" option, and the "suffix" is everything after the "template_name" option in temporary Community Template API Name.'
        class_path: dev.tasks.community_templates.ExportCommunityTemplateTask
        options:
            template_name: OFM_Portal
            suffix: "3"
            export_template: True
            export_theme: True
            export_branding_set: True
            export_flexipages: True
            copy_temporary_metadata: False

flows:
    config_dev:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: customer_enablement
            4:
                task: dev_secure_owds_by_default
            5:
                task: dev_deploy_unpackaged
            6:
                task: dev_load_storytelling_data
            7:
                task: dev_reorder_app_menu

    config_qa:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: customer_enablement
            4:
                task: dev_secure_owds_by_default
            5:
                task: qa_reorder_app_menu

    config_managed:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: customer_enablement
            4:
                task: dev_secure_owds_by_default
            5:
                task: dev_deploy_unpackaged
            6:
                task: dev_load_storytelling_data
            7:
                task: dev_reorder_app_menu

    2gp_org:
        steps:
            1:
                flow: install_2gp_commit
            2:
                flow: config_managed
            3:
                task: snapshot_changes

    customer_enablement:
        steps:
            1:
                task: create_fundseeker_site
            2:
                task: deploy_navigation_menu
