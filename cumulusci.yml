minimum_cumulusci_version: "3.27.0"
project:
    name: OutboundFundsCommunity
    package:
        name: Outbound Funds Community
        namespace: outfunds_comm
        api_version: "50.0"
    dependencies:
        - namespace: sfdobase
          version: 1.0
        - github: "https://github.com/SalesforceFoundation/OutboundFunds"
    git:
        default_branch: "main"
    source_format: sfdx

sources:
    outbound_funds:
        github: https://github.com/SalesforceFoundation/OutboundFunds
        release: latest_beta

orgs:
    scratch:
        2gp:
            config_file: orgs/dev.json
            days: 7

tasks:
    # Automerge Major Release Branches
    github_automerge_feature:
        options:
            update_future_releases: True

    robot:
        options:
            suites: robot/OutboundFundsCommunity/tests
            options:
                outputdir: robot/OutboundFundsCommunity/results

    robot_testdoc:
        options:
            path: robot/OutboundFundsCommunity/tests
            output: robot/OutboundFundsCommunity/doc/OutboundFundsCommunity_tests.html

    run_tests:
        options:
            required_org_code_coverage_percent: 100

    # Customer Enablement
    create_fundseeker_community:
        group: "OFM-Site: Customer enablement"
        description: "Creates a site with the OFM Experience Template."
        class_path: cumulusci.tasks.salesforce.CreateCommunity
        options:
            template: OFM-Portal
            name: Outbound Funds Portal
            url_path_prefix: outboundfunds
            timeout: 60000

    # Internal configuration
    dev_secure_owds_by_default:
        group: "OFM-Site: Internal configuration"
        description: Sets organization-wide default (OWD) sharing configuration as private both internally and externally.
        class_path: cumulusci.tasks.metadata_etl.SetOrgWideDefaults
        options:
            org_wide_defaults:
                - api_name: Account
                  internal_sharing_model: Private
                  external_sharing_model: Private
                # Opportunity + Case must have a sharing model â‰¤ Account's sharing model.
                - api_name: Opportunity
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: Case
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: User
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Funding_Program__c
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Funding_Request__c
                  internal_sharing_model: Private
                  external_sharing_model: Private
                - api_name: outfunds__Requirement__c
                  internal_sharing_model: Private
                  external_sharing_model: Private

    # Internal development automation
    dev_export_ofm_community_template:
        group: "OFM: Internal dev automation"
        description: 'Exports specified temporary Community Template metadata. Change the options to export changes you are interested in. Remember, the temporary Community Template API Name must start with "template_name" option, and the "suffix" is everything after the "template_name" option in temporary Community Template API Name.'
        class_path: dev.tasks.community_templates.ExportCommunityTemplateTask
        options:
            template_name: OFM_Portal
            suffix: "3"
            export_template: True
            export_theme: True
            export_branding_set: True
            export_flexipages: True
            copy_temporary_metadata: False

flows:
    config_dev:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: customer_enablement
            4:
                task: outbound_funds:load_dataset
            5:
                task: dev_secure_owds_by_default

    config_qa:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: customer_enablement
            4:
                task: outbound_funds:load_dataset
            5:
                task: dev_secure_owds_by_default

    config_managed:
        steps:
            # 1) task: deploy_post [from current folder]
            # 2) task: update_admin_profile
            3:
                flow: customer_enablement
            4:
                task: outbound_funds:load_dataset
            5:
                task: dev_secure_owds_by_default

    2gp_org:
        steps:
            1:
                flow: install_2gp_commit
            2:
                flow: config_managed
            3:
                task: snapshot_changes

    customer_enablement:
        steps:
            3:
                task: create_fundseeker_community
